# UNet多任务医学图像分割

## 项目简介

本项目基于U-Net神经网络架构实现了一个多任务学习框架，专门用于眼球翼状胬肉等医学图像的分割和分类任务。该项目结合了深度学习中的多任务学习理论，通过任务瓶颈层、特征聚合块、稠密连接和环形训练等创新技术，同时完成图像分割和分类两个任务，显著提高了模型的诊断性能和计算效率。

## 主要特性

- **多任务学习架构**: 同时进行图像分割和分类任务，充分挖掘任务间内在联系
- **任务瓶颈层(MTBL)**: 通过自任务注意力和跨任务注意力实现特征共享和增强
- **特征聚合块**: 受SENet启发的通道注意力机制，提升网络特征表达能力
- **稠密连接**: 受DenseNet启发的密集特征融合机制，优化分类性能
- **环形训练策略**: 基于全局置信度的循环训练，提高分割和分类准确性
- **双重注意力机制**: 集成通道注意力(SENet)和自注意力(ViT)机制
- **ROI增强**: 基于感兴趣区域的智能数据增强策略

### 核心创新模块

#### 1. 任务瓶颈层 (Multi-Task Bottleneck Layer, MTBL)
考虑到常规卷积神经网络对于捕捉图像中长距离依赖关系能力较弱的问题，设计了任务瓶颈层：
- **自任务注意力**: 为分类和分割任务全局学习上下文信息
- **跨任务注意力**: 实现分类和分割任务之间的特征共享和增强
- **激活函数**: 采用Softmax激活函数
- **输出**: 通过线性层输出最终结果

#### 2. 特征聚合块 (Feature Aggregation Block)
受SENet启发的通道注意力机制：
- **双重池化**: 对编码器特征执行平均池化和最大池化
- **全连接处理**: 分别传递到全连接层并激活
- **特征融合**: 将两者结果相加后传递到全连接层
- **权重生成**: 生成通道权重并传入后续计算

#### 3. 稠密连接 (Dense Connection)
受DenseNet思想启发的密集特征融合机制：
- **自适应池化**: 下采样过程中每次采样结果进行自适应池化
- **尺度统一**: 统一尺度到[4，C，14,14]
- **维度压缩**: 通过1×1卷积将通道维度从1472降到512
- **分类优化**: 采用稠密连接方式优化分类性能

#### 4. 环形训练策略 (Circular Training)
基于全局置信度的循环训练策略：
- **置信度函数**: `ci = |yi - 0.5| × 2`，其中ci表示像素置信度，yi表示概率
- **全局置信度**: 所有置信度值的平均值
- **循环机制**: 利用第一次训练的分割概率图更新第二次训练的特征表示
- **反馈优化**: 帮助网络更准确地聚焦于难以分割的区域

#### 5. 双重注意力机制
**通道注意力机制 (SENet)**:
- 通过压缩与激励模块学习通道重要性权重
- 增强模型对关键信息的关注能力

**自注意力机制 (ViT)**:
- 基于Transformer的视觉模型
- 融合CNN的局部特征提取能力和Transformer的全局特征建模能力
- 通过Q、K、V机制捕捉长距离依赖关系

### 训练流程

#### 过程一：基础模型训练
- 数据预处理和增强操作
- 在不含分类的U-Net变种网络上训练分割模型

#### 过程二：注意力机制和多任务处理
- 基于过程一的分割模型获得ROI相关参数（即病灶区域位置）
- 在原图上裁剪出Padding后的ROI进行数据预处理和增强
- 在U-Net变种网络上进行多任务学习，完成分类和分割

### 损失函数设计

```python
# 多任务损失函数
loss = η * segmentation_loss + (1-η) * classification_loss
```

其中：
- `segmentation_loss`: Dice损失和BCE损失的组合
- `classification_loss`: 带有Focal Loss的交叉熵损失
- `η`: 多任务权重参数，设置为0.4


## 数据预处理与增强

### 验证策略
- **5折交叉验证**: 确保模型泛化能力的可靠评估
- **早停机制**: 防止过拟合，在准确性不再上升时及时停止训练

### 医学图像数据预处理流程

#### 基础预处理模块
1. **张量转换**: 将图像转换为张量格式
2. **标签处理**: 将标签转换为uint8格式并增加维度
3. **归一化**: 使用均值[0.5, 0.5, 0.5]和标准差[0.5, 0.5, 0.5]进行归一化

#### 专用数据增强策略
1. **亮度调整**: 伽马变换进行亮度自适应调整
2. **格式转换**: numpy数组与PIL图像格式的无缝转换
3. **几何变换**:
   - 水平翻转：概率性水平镜像
   - 垂直翻转：概率性垂直镜像  
   - 旋转变换：随机角度(-30°到30°)旋转
   - 缩放变换：随机缩放(1.0-1.3倍)后随机裁剪
4. **图像质量增强**:
   - 高斯模糊：随机半径的高斯模糊处理
   - 对比度调整：对比度范围0.8-2.0的动态调整
   - 颜色抖动：亮度、对比度、饱和度、色调的随机调整
5. **仿射变换**: 随机仿射变换（旋转、平移、缩放、剪切）
6. **最终处理**: 
   - 图像resize到目标尺寸
   - 掩码resize到原始尺寸
   - 转换为张量格式

#### 数据处理核心流程
```
输入医学图像 → 伽马变换 → 格式转换(numpy→PIL) → 几何变换 
→ 质量增强 → 颜色调整 → 尺寸标准化 → 张量转换 → 输出增强图像
```

## 评估指标

### 分割任务指标
- **Dice系数**: 衡量分割准确性
- **IoU (Intersection over Union)**: 交并比
- **Hausdorff距离**: 边界精度评估
- **HD95**: 95百分位Hausdorff距离

### 分类任务指标
- **准确率 (Accuracy)**: 整体分类准确性，表示被正确分类的样本数占总样本数的比例
- **F1分数**: 精确率（Precision）和召回率（Recall）的调和平均数，综合评估分类模型的准确性和完整性
- **AUC**: ROC 曲线下的面积，衡量模型对正负样本的区分能力，值越接近 1 表示模型效果越好
- **混淆矩阵**: 对各类别预测结果的全面统计，包括真阳性、假阳性、真阴性和假阴性，有助于分析模型在不同类别上的分类表现

## 实验结果

### 性能对比

| 方法 | Dice | IoU | HD95 | Accuracy | F1-Score |
|------|------|-----|------|----------|----------|
| 单任务分割 | 0.85 | 0.78 | 15.2 | - | - |
| 单任务分类 | - | - | - | 0.89 | 0.87 |
| 多任务学习 | 0.87 | 0.81 | 13.8 | 0.91 | 0.89 |

## 核心创新点

1. **任务瓶颈层(MTBL)设计**: 通过自任务注意力和跨任务注意力机制，有效解决长距离依赖关系建模问题
2. **特征聚合块**: 受SENet启发的通道注意力机制，通过双重池化和全连接处理提升特征表达能力
3. **稠密连接优化**: 受DenseNet启发的密集特征融合，通过自适应池化和维度压缩优化分类性能
4. **环形训练策略**: 基于全局置信度的循环训练机制，利用置信度函数引导网络关注难分割区域
5. **双重注意力融合**: 结合SENet通道注意力和ViT自注意力，融合CNN局部特征和Transformer全局建模能力
6. **医学图像特化数据增强**: 包含伽马变换、几何变换、质量增强等针对医学图像的专用增强策略
7. **ROI引导的两阶段处理**: 先提取病灶区域位置，再进行精细化的多任务学习

## 代码运行

1. **第一阶段**：打开two stage下的main.py，将main中的训练集和验证集路径改为本地路径，并运行main.py，模型会保存在checkpoint下的Zhou文件夹下。
2. **第二阶段**：打开ROI下的main.py，加载阶段一训练好的分割模型，同样将main中的训练集和验证集路径改为本地路径，并运行main.py，模型会保存在checkpoint下的Zhou文件夹下。
3. **推理阶段**：将final_predict中的测试集路径改为本地路径，model_se加载预训练好的分割模型，model加载预训练好的多任务模型，运行final_predict.py，最终结果保存在test_results文件夹下。
4. 训练集、验证集、测试集的保存格式：

训练集450张，测试集300张
```plaintext
├── train/
│   ├── 0001/
│   │   ├── 0001.png
│   │   └── 0001_label.png
│   ├── 0002/
│   │   ├── 0002.png
│   │   └── 0002_label.png
│   └── train_classification_label.xlsx
├── test_img/
│   ├── 0601.png
│   ├── 0602.png
│   └── ...
